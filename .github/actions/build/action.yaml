name: "Build Android App"
description: "Build the Android app"

runs:
  using: "composite"
  steps:
    - name: Setup Java
      uses: actions/setup-java@v5
      with:
        distribution: zulu
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK
      run: sdkmanager "ndk;${{ env.NDK_VERSION }}"
      shell: bash

    - name: install Rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

    - name: Extract android signing key from env
      run: |
        echo "${{ env.ANDROID_RELEASE_KEYSTORE }}" > src-tauri/gen/android/upload-keystore.jks.base64
        base64 -d src-tauri/gen/android/upload-keystore.jks.base64 > src-tauri/gen/android/app/upload-keystore.jks
      shell: bash

    - name: Create key.properties
      run: |
        echo "keyAlias=upload" > src-tauri/gen/android/key.properties
        echo "password=${{ env.ANDROID_RELEASE_KEYSTORE_PASSWORD }}" >> src-tauri/gen/android/key.properties
        echo "storeFile=upload-keystore.jks" >> src-tauri/gen/android/key.properties
      shell: bash

    - run: pnpm run build:android:prod
      env:
        NDK_HOME: ${{ env.ANDROID_HOME }}/ndk/${{ env.NDK_VERSION }}
      shell: bash

    - name: Cleanup working directory
      run: |
        rm src-tauri/gen/android/upload-keystore.jks.base64
        rm src-tauri/gen/android/app/upload-keystore.jks
      shell: bash
